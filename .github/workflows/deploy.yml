name: Deploy All Course Slides to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
     
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
       
    - name: Install dependencies
      run: npm ci

    - name: Build SIMTA
      run: |
        echo "ðŸŽ“ Building SIMTA..."
        cd SIMTA
        npx slidev build presentation.md \
          --base "/mata-kuliah-slides/SIMTA/" \
          --out "../dist/SIMTA"
        cd ..
        echo "âœ… SIMTA ready"

    - name: Build CC Course (All Weeks)
      run: |
        echo "ðŸŒ Building Cloud Computing course..."
        for week in 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16; do
          echo "Building CC Week ${week}..."
          npx slidev build "CC/pertemuan-${week}/slides.md" \
            --base "/mata-kuliah-slides/CC/pertemuan-${week}/" \
            --out "dist/CC/pertemuan-${week}" || {
            echo "âš ï¸ CC Week ${week} build failed, continuing..."
          }
        done
        echo "âœ… CC course completed (16 weeks)"

    - name: Build DMJK Course (All Weeks)
      run: |
        echo "ðŸ”— Building DMJK course..."
        for week in 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16; do
          echo "Building DMJK Week ${week}..."
          npx slidev build "DMJK/pertemuan-${week}/slides.md" \
            --base "/mata-kuliah-slides/DMJK/pertemuan-${week}/" \
            --out "dist/DMJK/pertemuan-${week}" || {
            echo "âš ï¸ DMJK Week ${week} build failed, continuing..."
          }
        done
        echo "âœ… DMJK course completed (16 weeks)"

    - name: Build PROMOB Course (All Weeks)  
      run: |
        echo "ðŸ“± Building Mobile Programming course..."
        for week in 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16; do
          echo "Building PROMOB Week ${week}..."
          npx slidev build "PROMOB/pertemuan-${week}/slides.md" \
            --base "/mata-kuliah-slides/PROMOB/pertemuan-${week}/" \
            --out "dist/PROMOB/pertemuan-${week}" || {
            echo "âš ï¸ PROMOB Week ${week} build failed, continuing..."
          }
        done
        echo "âœ… PROMOB course completed (16 weeks)"

    - name: Build PROWEB Course (All Weeks)
      run: |
        echo "ðŸ’» Building Web Programming course..."
        for week in 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16; do
          echo "Building PROWEB Week ${week}..."
          npx slidev build "PROWEB/pertemuan-${week}/slides.md" \
            --base "/mata-kuliah-slides/PROWEB/pertemuan-${week}/" \
            --out "dist/PROWEB/pertemuan-${week}" || {
            echo "âš ï¸ PROWEB Week ${week} build failed, continuing..."
          }
        done
        echo "âœ… PROWEB course completed (16 weeks)"

    - name: Setup Landing Page
      run: |
        echo "ðŸ  Setting up landing page..."
        cp docs/index.html dist/index.html
        cp docs/style.css dist/style.css
        echo "âœ… Landing page ready"

    - name: Build Summary
      run: |
        echo "ðŸ“Š BUILD COMPLETED!"
        echo "=================="
        echo "Total pages built: $(find dist/ -name "index.html" 2>/dev/null | wc -l)"
        echo ""
        echo "Available courses:"
        echo "ðŸŽ“ SIMTA: $(find dist/SIMTA -name "index.html" 2>/dev/null | wc -l) presentation"
        echo "ðŸŒ CC: $(find dist/CC -name "index.html" 2>/dev/null | wc -l) weeks"
        echo "ðŸ”— DMJK: $(find dist/DMJK -name "index.html" 2>/dev/null | wc -l) weeks" 
        echo "ðŸ“± PROMOB: $(find dist/PROMOB -name "index.html" 2>/dev/null | wc -l) weeks"
        echo "ðŸ’» PROWEB: $(find dist/PROWEB -name "index.html" 2>/dev/null | wc -l) weeks"
        echo ""
        echo "ðŸš€ Ready for deployment!"

    - name: Setup Pages
      uses: actions/configure-pages@v4
     
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4